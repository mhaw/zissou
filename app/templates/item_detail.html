{% extends 'base.html' %}


{% block meta %}
    {% set share_title = item.title or 'Untitled Article' %}
    {% set share_author = item.author or 'Unknown Author' %}
    {% set share_url = url_for('main.item_detail', item_id=item.id, _external=True) %}
    {% set share_host = url_host(item.sourceUrl) if item.sourceUrl else '' %}
    {% set share_image = item.imageUrl or url_for('static', filename='img/zissou_logo.png', _external=True) %}
    {% set raw_description = (item.text or '') | replace('\r\n', ' ') | replace('\r', ' ') | replace('\n', ' ') %}
    {% set share_description = raw_description.strip() %}
    {% if share_description|length == 0 and share_host %}
        {% set share_description = 'From ' ~ share_host %}
    {% endif %}
    {% if share_description|length > 200 %}
        {% set share_description = share_description[:197].rstrip() ~ '…' %}
    {% endif %}
    {% if item.publishedAt %}
        {% set publish_iso = item.publishedAt.isoformat() %}
    {% else %}
        {% set publish_iso = None %}
    {% endif %}
    {% if share_host %}
        {% set share_title = share_title ~ ' · ' ~ share_host %}
    {% endif %}
    {% if share_description|length == 0 %}
        {% set share_description = share_title %}
    {% endif %}
    <meta name="description" content="{{ share_description }}">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Zissou">
    <meta property="og:title" content="{{ share_title }}">
    <meta property="og:description" content="{{ share_description }}">
    <meta property="og:url" content="{{ share_url }}">
    <meta property="og:image" content="{{ share_image }}">
    {% if item.audioUrl %}
    <meta property="og:audio" content="{{ item.audioUrl }}">
    <meta property="og:audio:type" content="audio/mpeg">
    {% endif %}
    {% if publish_iso %}
    <meta property="article:published_time" content="{{ publish_iso }}">
    {% endif %}
    <meta property="article:author" content="{{ share_author }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ share_title }}">
    <meta name="twitter:description" content="{{ share_description }}">
    <meta name="twitter:image" content="{{ share_image }}">
    <meta name="twitter:url" content="{{ share_url }}">
{% endblock %}

{% block title %}{{ item.title }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-md">
    <div class="mb-4">
        <a href="{{ url_for('main.index') }}" class="text-blue-500 hover:underline">&larr; Back to List</a>
    </div>
    <h1 class="text-3xl font-bold mb-2">{{ item.title }}</h1>
    <p class="text-gray-600 mb-4">By {{ item.author | default('Unknown Author') }}</p>

    {% if item.imageUrl %}
    <div class="my-4">
        <img src="{{ item.imageUrl }}" alt="{{ item.title }}" class="w-full h-auto rounded-lg shadow-sm">
    </div>
    {% endif %}

    <p class="text-sm text-gray-500 mb-4">
        Added on {{ item.createdAt.strftime('%Y-%m-%d') if item.createdAt }}
        {% if item.publishedAt %}<br>Published on {{ item.publishedAt.strftime('%Y-%m-%d') }}{% endif %}
    </p>

    <div class="mb-4" id="item-tag-summary-wrapper">
        <div class="flex flex-wrap gap-2" id="item-tag-summary" data-tag-summary>
            {% include 'partials/_tag_summary.html' %}
        </div>
    </div>

    <div class="mb-4" id="item-bucket-summary-wrapper">
        <div class="flex flex-wrap gap-2" data-bucket-summary>
            {% set bucket_ids = item.buckets or [] %}
            {% include 'partials/_bucket_summary.html' %}
        </div>
    </div>

    {% if item.audioUrl %}
    {% set media_image = item.imageUrl or url_for('static', filename='img/zissou_logo.png', _external=True) %}
    <div class="my-6" data-audio-player
         data-title="{{ item.title or 'Untitled Article' }}"
         data-artist="{{ item.author or 'Unknown Author' }}"
         data-source="{{ item.sourceUrl }}"
         data-artwork="{{ media_image }}"
         data-duration="{{ item.durationSeconds or '' }}">
        <div class="mb-3 rounded-lg border border-slate-200 bg-slate-50 p-4 shadow-sm">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-700" data-audio-label>{{ item.title }}</p>
                    <p class="text-xs uppercase tracking-wide text-slate-500">{{ item.author or 'Unknown Author' }}</p>
                </div>
                <div class="text-xs font-medium text-slate-500">
                    <span data-audio-current>0:00</span>
                    <span aria-hidden="true"> / </span>
                    <span data-audio-duration>{% if item.durationSeconds %}{{ item.durationSeconds|format_duration }}{% else %}—{% endif %}</span>
                </div>
            </div>
            <div class="mt-3 h-1.5 w-full overflow-hidden rounded-full bg-slate-200" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" data-audio-progress-track>
                <div class="h-full w-0 bg-blue-500 transition-[width] duration-150 ease-out" data-audio-progress-bar></div>
            </div>
        </div>
        <audio id="article-audio"
               class="w-full"
               controls
               preload="metadata"
               playsinline
               title="{{ item.title or 'Untitled Article' }}"
               aria-label="Play narration for {{ item.title or 'this article' }}">
            <source src="{{ item.audioUrl }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>
    {% endif %}

    <div class="mt-6 pt-4 border-t">
        <h3 class="font-bold">Details</h3>
        <p class="flex items-center flex-wrap gap-2">
            <span><strong>Source:</strong> <a href="{{ item.sourceUrl }}" class="text-blue-500 hover:underline" target="_blank" rel="noopener noreferrer">Read Original</a></span>
            <button type="button" class="text-sm text-gray-500 hover:text-gray-700" data-copy-source data-copy-url="{{ item.sourceUrl }}">Copy link</button>
            <span id="copy-feedback" class="text-sm text-green-600 hidden" role="status" aria-live="polite"></span>
        </p>
        {% if item.audioSizeBytes %}
        <p><strong>Audio Size:</strong> {{ '%.2f'|format(item.audioSizeBytes / 1024 / 1024) }} MB</p>
        {% endif %}
    </div>

    <div class="mt-6 pt-4 border-t">
        <h3 class="font-bold">Processing Metrics</h3>
        <p><strong>Processing Time:</strong> {{ item.processingTimeMs }} ms</p>
        <p><strong>Voice Setting:</strong> {{ item.voiceSetting }}</p>
        <p><strong>Pipeline Tools:</strong> {{ item.pipelineTools | join(', ') }}</p>
    </div>

    <div class="mt-6 pt-4 border-t">
        <h3 class="font-bold mb-4">Assign to Buckets</h3>
        <form method="post" data-async-form="buckets" data-item-id="{{ item.id }}" data-endpoint="{{ url_for('main.update_item_buckets_api', item_id=item.id) }}">
            <div class="space-y-3" data-bucket-selector
                 data-field-name="bucket_ids"
                 data-all-buckets='{{ bucket_options | tojson }}'
                 data-selected-buckets='{{ (item.buckets or []) | tojson }}'
                 data-create-url='{{ url_for('main.list_buckets') }}'>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-semibold text-slate-700">Buckets</label>
                    <span class="text-xs uppercase tracking-wide text-slate-400">
                        <span data-bucket-selector-count>{{ (item.buckets or []) | length }}</span> selected
                    </span>
                </div>
                <div class="flex flex-wrap gap-2" data-bucket-chip-list></div>
                <div class="flex flex-wrap gap-2" data-bucket-option-list></div>
                <p class="text-xs text-slate-500">Click a bucket to toggle it. Selected buckets appear above.</p>
                <div data-bucket-hidden-inputs></div>
            </div>
            <noscript>
                <div class="mt-4 space-y-2">
                    {% for bucket in buckets %}
                    <label class="flex items-center">
                        <input type="checkbox" name="bucket_ids" value="{{ bucket.id }}"
                               {% if bucket.id in (item.buckets or []) %}checked{% endif %}
                               class="form-checkbox h-5 w-5 text-blue-600">
                        <span class="ml-2 text-gray-700">{{ bucket.name }}</span>
                    </label>
                    {% else %}
                    <p class="text-gray-500">No buckets have been created yet. <a href="{{ url_for('main.list_buckets') }}" class="text-blue-500 hover:underline">Create one?</a></p>
                    {% endfor %}
                </div>
            </noscript>
            <div class="mt-4">
                <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    Save Buckets
                </button>
            </div>
            <p class="mt-3 text-sm text-slate-500 hidden" data-bucket-status role="status"></p>
        </form>
    </div>

    <div class="mt-6 border-t pt-4" id="tags">
        <h3 class="mb-4 font-bold">Manage Tags</h3>
        <form method="post" class="space-y-4" data-async-form="tags" data-item-id="{{ item.id }}" data-endpoint="{{ url_for('main.update_item_tags_api', item_id=item.id) }}">
            <div class="space-y-3" data-tag-selector
                 data-mode="edit"
                 data-field-name="tags"
                 data-all-tags='{{ all_tags | tojson }}'
                 data-selected-tags='{{ item.tags | tojson }}'>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-semibold text-slate-700">Tags</label>
                    <span class="text-xs uppercase tracking-wide text-slate-400">Autocomplete enabled</span>
                </div>
                <div class="flex flex-wrap gap-2" data-tag-chip-list></div>
                <div class="relative">
                    <input type="text" data-tag-input placeholder="Type to add tags"
                           class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100">
                    <div data-tag-suggestions class="absolute left-0 right-0 top-full z-10 mt-1 hidden rounded-xl border border-slate-200 bg-white py-2 text-sm shadow-lg"></div>
                </div>
                <p class="text-xs text-slate-500">Press Enter to add a tag, click a chip to remove it. New tags are created automatically.</p>
                <div data-tag-hidden-inputs></div>
            </div>
            <noscript>
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-700" for="tags-fallback">Tags</label>
                    <input id="tags-fallback" type="text" name="tags" value="{{ item.tags | join(', ') }}" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm" placeholder="Enter comma-separated tags">
                </div>
            </noscript>
            <div>
                <button type="submit" name="submit_tags" class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    Save Tags
                </button>
            </div>
            <p class="text-sm text-slate-500 hidden" data-tag-status role="status"></p>
        </form>
    </div>

    {% if item.text %}
    <div class="prose max-w-none mt-6 pt-4 border-t">
        <h3 class="font-bold">Full Text</h3>
        {{ item.text | nl2p | safe }}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/item-detail.js') }}"></script>
<script>
    (function() {
        const copyButton = document.querySelector('[data-copy-source]');
        const feedback = document.getElementById('copy-feedback');
        let hideTimeout;

        function showFeedback(message, isError) {
            if (!feedback) {
                return;
            }
            feedback.textContent = message;
            feedback.classList.remove('hidden');
            feedback.classList.toggle('text-green-600', !isError);
            feedback.classList.toggle('text-red-600', isError);
            if (hideTimeout) {
                clearTimeout(hideTimeout);
            }
            hideTimeout = window.setTimeout(() => {
                feedback.classList.add('hidden');
            }, 2500);
        }

        if (copyButton && navigator.clipboard) {
            copyButton.addEventListener('click', () => {
                const url = copyButton.getAttribute('data-copy-url');
                navigator.clipboard.writeText(url).then(() => {
                    showFeedback('Link copied', false);
                }).catch((error) => {
                    console.error('Clipboard copy failed', error);
                    showFeedback('Copy failed', true);
                });
            });
        } else if (copyButton) {
            copyButton.addEventListener('click', () => {
                showFeedback('Clipboard unavailable', true);
            });
        }
    })();
</script>
{% endblock %}
