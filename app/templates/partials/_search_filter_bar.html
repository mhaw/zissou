{% set current_view_args = request.view_args or {} %}
<div class="mb-6 space-y-4">
    <div class="flex flex-col gap-4 md:flex-row">
        <div class="relative flex-grow">
            <input type="search" name="q" placeholder="Search items (title, source, tags)"
                   class="w-full rounded-xl border border-slate-200 bg-white p-3 pl-11 text-base shadow-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                   value="{{ params.q or '' }}"
                   hx-get="{{ url_for(request.endpoint, **current_view_args) }}"
                   hx-trigger="keyup changed delay:500ms, search"
                   hx-target="#item-list-container"
                   hx-swap="outerHTML"
                   hx-indicator="#search-indicator">
            <svg class="pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z" />
            </svg>
            <div id="search-indicator" class="htmx-indicator absolute right-3 top-1/2 -translate-y-1/2">
                <svg class="h-5 w-5 animate-spin text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
        <div class="flex items-center justify-end gap-3">
            {% if selected_tags or params.bucket or params.duration %}
            <button id="quick-clear-filters" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm transition hover:bg-slate-50">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Clear active filters
            </button>
            {% endif %}
            <button id="filter-toggle" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-100">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18M3 12h12M3 20h6" />
                </svg>
                Filters
            </button>
        </div>
    </div>

    {% if selected_tags or params.bucket or params.duration %}
    <div class="flex flex-wrap items-center gap-2 text-xs font-medium text-slate-600">
        <span class="uppercase tracking-wide text-slate-400">Active:</span>
        {% for tag in selected_tags %}
        <form method="get" class="inline" hx-get="{{ url_for(request.endpoint, **current_view_args) }}" hx-target="#item-list-container" hx-swap="outerHTML">
            {% for name, value in params.items() if name not in ['tags', 'after'] %}
                {% if value %}
                    <input type="hidden" name="{{ name }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            {% for active_tag in selected_tags %}
                {% if active_tag != tag %}
                    <input type="hidden" name="tags" value="{{ active_tag }}">
                {% endif %}
            {% endfor %}
            <button type="submit" class="inline-flex items-center gap-1 rounded-full border border-blue-200 bg-blue-50 px-2.5 py-1 text-xs text-blue-700 hover:bg-blue-100">
                {{ tag }}
                <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </form>
        {% endfor %}
        {% if params.bucket %}
        <form method="get" class="inline" hx-get="{{ url_for(request.endpoint, **current_view_args) }}" hx-target="#item-list-container" hx-swap="outerHTML">
            {% for name, value in params.items() if name not in ['bucket', 'after'] %}
                {% if name == 'tags' %}
                    {% for active_tag in selected_tags %}
                        <input type="hidden" name="tags" value="{{ active_tag }}">
                    {% endfor %}
                {% elif value %}
                    <input type="hidden" name="{{ name }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <button type="submit" class="inline-flex items-center gap-1 rounded-full border border-purple-200 bg-purple-50 px-2.5 py-1 text-xs text-purple-700 hover:bg-purple-100">
                Bucket filter
                <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </form>
        {% endif %}
        {% if params.duration %}
        <form method="get" class="inline" hx-get="{{ url_for(request.endpoint, **current_view_args) }}" hx-target="#item-list-container" hx-swap="outerHTML">
            {% for name, value in params.items() if name not in ['duration', 'after'] %}
                {% if name == 'tags' %}
                    {% for active_tag in selected_tags %}
                        <input type="hidden" name="tags" value="{{ active_tag }}">
                    {% endfor %}
                {% elif value %}
                    <input type="hidden" name="{{ name }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <button type="submit" class="inline-flex items-center gap-1 rounded-full border border-teal-200 bg-teal-50 px-2.5 py-1 text-xs text-teal-700 hover:bg-teal-100">
                Duration: {{ params.duration }}
                <svg class="h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </form>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="filter-overlay" class="hidden rounded-2xl border border-slate-200 bg-white p-6 shadow-xl">
    <form hx-get="{{ url_for(request.endpoint, **current_view_args) }}"
          hx-target="#item-list-container"
          hx-swap="outerHTML"
          hx-indicator="#search-indicator">
        <input type="hidden" name="q" value="{{ params.q or '' }}">
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
            <div>
                <label for="include_archived" class="mb-2 block text-sm font-semibold text-slate-700">Archived Items</label>
                <input type="checkbox" id="include_archived" name="include_archived" value="true" {% if params.include_archived %}checked{% endif %}
                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                       onchange="this.form.submit()">
                <label for="include_archived" class="ml-2 text-sm text-slate-700">Show archived items</label>
            </div>

            <div>
                <label for="include_read" class="mb-2 block text-sm font-semibold text-slate-700">Read Items</label>
                <input type="checkbox" id="include_read" name="include_read" value="true" {% if params.include_read %}checked{% endif %}
                       class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                       onchange="this.form.submit()">
                <label for="include_read" class="ml-2 text-sm text-slate-700">Show read items</label>
            </div>

            {% if buckets %}
            <div>
                <label for="bucket" class="mb-2 block text-sm font-semibold text-slate-700">Bucket</label>
                <select id="bucket" name="bucket" class="w-full rounded-xl border border-slate-200 bg-white p-3 text-sm shadow-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"
                        onchange="this.form.submit()">
                    <option value="">All Buckets</option>
                    {% for bucket in buckets %}
                    <option value="{{ bucket.id }}" {% if params.bucket == bucket.id %}selected{% endif %}>{{ bucket.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div>
                <span class="mb-2 block text-sm font-semibold text-slate-700">Duration</span>
                <div class="flex flex-wrap gap-2">
                    {% set duration_presets = [('', 'Any'), ('short', '< 5 min'), ('medium', '5-15 min'), ('long', '> 15 min')] %}
                    {% for value, label in duration_presets %}
                        <button type="submit" name="duration" value="{{ value }}"
                                class="inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-sm font-medium transition
                                {% if (params.duration or '') == value %}border-blue-500 bg-blue-500 text-white shadow
                                {% else %}border-slate-200 bg-slate-100 text-slate-700 hover:bg-slate-200{% endif %}">
                            {{ label }}
                        </button>
                    {% endfor %}
                </div>
            </div>

            <div class="md:col-span-2 xl:col-span-3" data-tag-selector
                 data-mode="filter"
                 data-field-name="tags"
                 data-all-tags='{{ all_tags | tojson }}'
                 data-selected-tags='{{ selected_tags | list | tojson }}'>
                <div class="flex items-center justify-between">
                    <label class="text-sm font-semibold text-slate-700">Tags</label>
                    <span class="text-xs uppercase tracking-wide text-slate-400">Autocomplete + multi-select</span>
                </div>
                <div class="mt-3 flex flex-wrap gap-2" data-tag-chip-list></div>
                <div class="relative mt-2">
                    <input type="text" data-tag-input placeholder="Type to add tags"
                           class="w-full rounded-xl border border-slate-200 bg-white p-3 text-sm shadow-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100">
                    <div data-tag-suggestions class="absolute left-0 right-0 top-full z-10 mt-1 hidden rounded-xl border border-slate-200 bg-white py-2 text-sm shadow-lg"></div>
                </div>
                <p class="mt-2 text-xs text-slate-500">Press Enter to add the highlighted tag, click a chip to remove it.</p>
                <div data-tag-hidden-inputs></div>
            </div>
        </div>
        <div class="mt-6 flex justify-between gap-3">
            <button type="button" id="clear-filters" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 shadow-sm hover:bg-slate-50">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Reset
            </button>
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                Apply Filters
            </button>
        </div>
    </form>
</div>

<script nonce="{{ csp_nonce() }}">
    (function() {
        const filterToggle = document.getElementById('filter-toggle');
        const quickClear = document.getElementById('quick-clear-filters');
        const filterOverlay = document.getElementById('filter-overlay');
        const clearFiltersButton = document.getElementById('clear-filters');
        const searchInput = document.querySelector('input[type="search"][name="q"]');

        function toggleOverlay() {
            if (!filterOverlay) {
                return;
            }
            filterOverlay.classList.toggle('hidden');
            filterToggle?.setAttribute('aria-expanded', filterOverlay.classList.contains('hidden') ? 'false' : 'true');
        }

        filterToggle?.addEventListener('click', toggleOverlay);

        quickClear?.addEventListener('click', function(event) {
            event.preventDefault();
            if (window.TagSelectorRegistry) {
                window.TagSelectorRegistry.clearByMode('filter');
            }
            const url = new URL(window.location.href);
            ['bucket', 'duration', 'after'].forEach(param => url.searchParams.delete(param));
            url.searchParams.delete('tags');
            url.searchParams.delete('tag');
            if (searchInput) {
                url.searchParams.set('q', searchInput.value || '');
            }
            window.location.assign(url.toString());
        });

        clearFiltersButton?.addEventListener('click', function() {
            const url = new URL(window.location.href);
            // Clear all filter-related parameters
            ['q', 'bucket', 'duration', 'after', 'tags', 'tag', 'include_archived', 'include_read'].forEach(param => url.searchParams.delete(param));

            // Reset tag selector if it exists
            if (window.TagSelectorRegistry) {
                window.TagSelectorRegistry.clearByMode('filter');
            }

            // Navigate to the base URL to clear all filters
            window.location.assign(url.origin + url.pathname);
        });
    })();
</script>
