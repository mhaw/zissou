{% set endpoint = request.endpoint or '' %}
{% set browse_active = endpoint in ['main.index', 'main.item_detail'] %}
{% set buckets_active = endpoint in ['main.list_buckets', 'main.bucket_items'] %}
{% set feeds_active = endpoint.startswith('feeds.') or endpoint.startswith('public_feed.') %}
{% set admin_active = endpoint.startswith('admin.') %}
{% set import_active = endpoint == 'main.import_readwise' %}
{% set auth_enabled = config.get('AUTH_ENABLED', False) %}
{% set auth_backend = config.get('AUTH_BACKEND', 'iap') %}
{% set current_user = g.user if g.user else user|default(None) %}
<header class="bg-white shadow-md rounded-lg p-4 mb-6 transition-colors duration-300 dark:bg-slate-800 dark:shadow-slate-900">
    <nav class="flex flex-wrap items-center justify-between gap-4">
        <a href="{{ url_for('main.index') }}" class="flex items-center space-x-3">
            <img src="{{ url_for('static', filename='img/zissou_logo.png') }}" alt="Zissou Logo" class="h-8 w-8">
            <span class="text-2xl font-bold text-blue-600 dark:text-blue-300">Zissou Boombox</span>
        </a>
        <button type="button"
                id="primary-nav-toggle"
                class="md:hidden inline-flex items-center justify-center rounded-md border border-gray-300 p-2 text-gray-600 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-slate-200 dark:border-slate-600"
                aria-expanded="false"
                aria-controls="primary-nav">
            <span class="sr-only">Toggle navigation</span>
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        <div id="primary-nav" class="hidden w-full flex flex-col gap-2 md:flex md:w-auto md:flex-row md:items-center md:gap-2">
            <a href="{{ url_for('main.new_item') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-500 text-white shadow-sm' if endpoint == 'main.new_item' else 'bg-blue-600 text-white hover:bg-blue-700' }}">
                Submit URL
            </a>
            <a href="{{ url_for('main.import_readwise') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if import_active else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Import Readwise
            </a>
            <a href="{{ url_for('main.index') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if browse_active else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Browse Items
            </a>
            <a href="{{ url_for('main.surprise_me') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300">
                Surprise Me!
            </a>
            <a href="{{ url_for('main.list_buckets') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if buckets_active else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Buckets
            </a>
            <a href="{{ url_for('feeds.feed_list') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if feeds_active else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Feeds
            </a>
            {% if current_user and current_user.role == 'admin' %}
            <a href="{{ url_for('admin.index') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if admin_active else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Admin
            </a>
            <a href="{{ url_for('main.archived_items') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if request.endpoint == 'main.archived_items' else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Archived
            </a>
            <a href="{{ url_for('main.smart_buckets') }}"
               class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if request.endpoint == 'main.smart_buckets' else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                Smart Buckets
            </a>
            {% endif %}
            <button type="button"
                    id="theme-toggle"
                    class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-white"
                    aria-label="Toggle theme">
                <span data-theme-icon="moon" aria-hidden="true">üåô</span>
                <span data-theme-icon="sun" aria-hidden="true" class="hidden">‚òÄÔ∏è</span>
            </button>
            {% if auth_enabled and auth_backend == 'firebase' %}
                {% if current_user %}
                    <a href="{{ url_for('main.profile') }}"
                       class="px-4 py-2 rounded-md transition-colors duration-150 {{ 'bg-blue-50 text-blue-700 font-semibold' if request.endpoint == 'main.profile' else 'text-gray-600 hover:text-blue-600 dark:text-slate-200 dark:hover:text-blue-300' }}">
                        Profile
                    </a>
                    <button type="button" id="logout-button" class="px-4 py-2 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 md:ml-2 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600">
                        Sign out
                    </button>
                {% else %}
                    <a href="{{ url_for('auth.login', next=request.path) }}"
                       class="px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700">
                        Sign in
                    </a>
                {% endif %}
            {% elif auth_enabled and current_user %}
                <span class="px-4 py-2 rounded-md bg-gray-100 text-gray-700 md:ml-2 dark:bg-slate-700 dark:text-slate-100">Signed in as {{ current_user.email }}</span>
            {% endif %}
        </div>
    </nav>
</header>
<script nonce="{{ csp_nonce() }}">
    document.addEventListener('DOMContentLoaded', function() {
        const navToggle = document.getElementById('primary-nav-toggle');
        const navMenu = document.getElementById('primary-nav');

        if (navToggle && navMenu) {
            navToggle.addEventListener('click', function() {
                const isHidden = navMenu.classList.toggle('hidden');
                navToggle.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
            });
        }

        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', function() {
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                fetch('{{ url_for("auth.logout_post") }}', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-Token': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    if (response.ok) {
                        window.location.href = '{{ url_for("auth.login") }}';
                    } else {
                        alert('Logout failed. Please try again.');
                    }
                }).catch(error => {
                    console.error('Logout error:', error);
                    alert('An error occurred during logout.');
                });
            });
        }
    });
</script>
