{# This partial represents a single row in the admin task table for desktop view. #}
{% set health = task_health.get(task.id) %}
{% set row_classes = 'bg-yellow-50' if health and health.is_stale else 'bg-white' %}
<tr class="{{ row_classes }} hover:bg-gray-50 transition">
    <td class="px-3 py-2 border-b border-gray-200 align-top">
        {% set badge_class = status_colors.get(task.status, 'bg-gray-200 text-gray-700') %}
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ badge_class }}">{{ task.status.replace('_', ' ').title() }}</span>
        {% if task.retryCount and task.retryCount > 0 %}
            <span class="mt-1 block text-xs text-gray-600">Retries: {{ task.retryCount }}</span>
        {% endif %}
        {% if health and health.age %}
            <span class="mt-1 block text-xs {{ 'text-red-600 font-semibold' if health.is_stale else 'text-gray-500' }}">In stage {{ (health.age.total_seconds()) | format_duration }}</span>
        {% endif %}
    </td>
    <td class="px-3 py-2 border-b border-gray-200 align-top">
        <div class="max-w-lg">
            <a href="{{ task.sourceUrl }}" class="text-blue-600 hover:underline break-words" target="_blank" rel="noopener noreferrer">{{ task.sourceUrl }}</a>
            <div class="mt-1 text-xs text-gray-500 flex flex-wrap gap-x-3 gap-y-1">
                {% if task.voice %}<span class="uppercase tracking-wide">Voice: {{ task.voice }}</span>{% endif %}
                {% if task.bucket_id %}<span>Bucket: {{ task.bucket_id }}</span>{% endif %}
            </div>
        </div>
    </td>
    <td class="px-3 py-2 border-b border-gray-200 text-gray-700 align-top">
        <div class="text-xs">
            <div class="font-semibold">Created</div>
            <div>{{ task.createdAt | format_datetime }}</div>
            <div class="font-semibold mt-1">Updated</div>
            <div>{{ task.updatedAt | format_datetime }}</div>
        </div>
    </td>
    <td class="px-3 py-2 border-b border-gray-200 align-top">
        {% if task.error or task.errorCode %}
            <details class="group">
                <summary class="flex items-center gap-2 text-xs font-semibold text-rose-600 cursor-pointer select-none">
                    <span>Error details</span>
                    <svg class="h-3 w-3 text-rose-500 transition-transform group-open:rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </summary>
                <div class="mt-2 space-y-1 text-sm text-rose-600">
                    {% if task.errorCode %}
                    <div class="text-xs font-semibold uppercase tracking-wide">{{ task.errorCode }}</div>
                    {% endif %}
                    {% if task.error %}
                    <p>{{ task.error }}</p>
                    {% endif %}
                </div>
            </details>
        {% else %}
            <span class="text-xs text-gray-400">No errors</span>
        {% endif %}
    </td>
    <td class="px-3 py-2 border-b border-gray-200 align-top">
        <div class="flex flex-wrap items-center gap-2 text-sm">
            <a href="{{ url_for('main.progress_page', task_id=task.id) }}" class="text-blue-600 hover:underline">Progress</a>
            {% if task.item_id %}
                <a href="{{ url_for('main.item_detail', item_id=task.item_id) }}" class="text-blue-600 hover:underline">View Item</a>
                <form method="post" action="{{ url_for('admin.delete_item', item_id=task.item_id) }}" class="inline" data-confirm="Are you sure you want to delete this article? This action cannot be undone.">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="return_to" value="{{ request.full_path }}">
                    <button type="submit" class="text-rose-600 hover:underline">Delete Item</button>
                </form>
            {% endif %}
            {% if task.status in retryable_statuses or (health and health.is_stale) %}
                <form method="post" action="{{ url_for('admin.retry_processing', task_id=task.id) }}" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="text-orange-600 hover:underline">Retry</button>
                </form>
            {% endif %}
        </div>
    </td>
</tr>
